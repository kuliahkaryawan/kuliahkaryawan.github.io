!function(t){"use strict";var e=function(i,n){this.$element=t(i),this.options=t.extend({},e.DEFAULTS,n),this.$element.css({position:"relative",width:this.options.width+"px",margin:"0 auto"}),this.init()};e.VERSION="1.0",e.Author="argo@163.com",e.DEFAULTS={width:280,height:155,PI:Math.PI,sliderL:42,sliderR:9,offset:5,loadingText:"正在加载中...",failedText:"再试一次",barText:"向右滑动填充拼图",repeatIcon:"fa fa-repeat",maxLoadCount:3,localImages:function(){return"images/Pic"+Math.round(4*Math.random())+".jpg"},verify:function(e,i){var n=!1;return t.ajax({url:i,data:JSON.stringify(e),async:!1,cache:!1,type:"POST",contentType:"application/json",dataType:"json",success:function(t){n=t}}),n},remoteUrl:null},t.fn.sliderCaptcha=function(i){return this.each(function(){var n=t(this),o=n.data("lgb.SliderCaptcha"),s="object"==typeof i&&i;o&&!/reset/.test(i)||(o||n.data("lgb.SliderCaptcha",o=new e(this,s)),"string"==typeof i&&o[i]())})},t.fn.sliderCaptcha.Constructor=e;var i=e.prototype;i.init=function(){this.initDOM(),this.initImg(),this.bindEvents()},i.initDOM=function(){var e=function(t,e){var i=document.createElement(t);return i.className=e,i},i=function(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}(this.options.width-2,this.options.height),n=i.cloneNode(!0),o=e("div","sliderContainer"),s=e("i","refreshIcon "+this.options.repeatIcon),r=e("div","sliderMask"),a=e("div","sliderbg"),l=e("div","slider"),c=e("i","fa fa-arrow-right sliderIcon"),d=e("span","sliderText");n.className="block",d.innerHTML=this.options.barText;var h=this.$element;h.append(t(i)),h.append(t(s)),h.append(t(n)),l.appendChild(c),r.appendChild(l),o.appendChild(a),o.appendChild(r),o.appendChild(d),h.append(t(o));var p={canvas:i,block:n,sliderContainer:t(o),refreshIcon:s,slider:l,sliderMask:r,sliderIcon:c,text:t(d),canvasCtx:i.getContext("2d"),blockCtx:n.getContext("2d")};t.isFunction(Object.assign)?Object.assign(this,p):t.extend(this,p)},i.initImg=function(){var e=this,i=window.navigator.userAgent.indexOf("Trident")>-1,n=this.options.sliderL+2*this.options.sliderR+3,o=function(t,n){var o=e.options.sliderL,s=e.options.sliderR,r=e.options.PI,a=e.x,l=e.y;t.beginPath(),t.moveTo(a,l),t.arc(a+o/2,l-s+2,s,.72*r,2.26*r),t.lineTo(a+o,l),t.arc(a+o+s-2,l+o/2,s,1.21*r,2.78*r),t.lineTo(a+o,l+o),t.lineTo(a,l+o),t.arc(a+s-2,l+o/2,s+.4,2.76*r,1.24*r,!0),t.lineTo(a,l),t.lineWidth=2,t.fillStyle="rgba(255, 255, 255, 0.7)",t.strokeStyle="rgba(255, 255, 255, 0.7)",t.stroke(),t[n](),t.globalCompositeOperation=i?"xor":"destination-over"},s=function(t,e){return Math.round(Math.random()*(e-t)+t)},r=new Image;r.crossOrigin="Anonymous";var a=0;r.onload=function(){e.x=s(n+10,e.options.width-(n+10)),e.y=s(10+2*e.options.sliderR,e.options.height-(n+10)),o(e.canvasCtx,"fill"),o(e.blockCtx,"clip"),e.canvasCtx.drawImage(r,0,0,e.options.width-2,e.options.height),e.blockCtx.drawImage(r,0,0,e.options.width-2,e.options.height);var t=e.y-2*e.options.sliderR-1,i=e.blockCtx.getImageData(e.x-3,t,n,n);e.block.width=n,e.blockCtx.putImageData(i,0,t+1),e.text.text(e.text.attr("data-text"))},r.onerror=function(){a++,"file:"===window.location.protocol&&(a=e.options.maxLoadCount,console.error("can't load pic resource file from File protocal. Please try http or https")),a>=e.options.maxLoadCount?e.text.text("加载失败").addClass("text-danger"):r.src=e.options.localImages()},r.setSrc=function(){var n="";if(a=0,e.text.removeClass("text-danger"),t.isFunction(e.options.setSrc)&&(n=e.options.setSrc()),n&&""!==n||(n="https://picsum.photos/"+e.options.width+"/"+e.options.height+"/?image="+Math.round(20*Math.random())),i){var o=new XMLHttpRequest;o.onloadend=function(t){var e=new FileReader;e.readAsDataURL(t.target.response),e.onloadend=function(t){r.src=t.target.result}},o.open("GET",n),o.responseType="blob",o.send()}else r.src=n},r.setSrc(),this.text.attr("data-text",this.options.barText),this.text.text(this.options.loadingText),this.img=r},i.clean=function(){this.canvasCtx.clearRect(0,0,this.options.width,this.options.height),this.blockCtx.clearRect(0,0,this.options.width,this.options.height),this.block.width=this.options.width},i.bindEvents=function(){var e=this;this.$element.on("selectstart",function(){return!1}),t(this.refreshIcon).on("click",function(){e.text.text(e.options.barText),e.reset(),t.isFunction(e.options.onRefresh)&&e.options.onRefresh.call(e.$element)});var i,n,o=[],s=!1,r=function(t){e.text.hasClass("text-danger")||(i=t.clientX||t.touches[0].clientX,n=t.clientY||t.touches[0].clientY,s=!0)},a=function(t){if(t.preventDefault(),!s)return!1;var r=t.clientX||t.touches[0].clientX,a=t.clientY||t.touches[0].clientY,l=r-i,c=a-n;if(l<0||l+40>e.options.width)return!1;e.slider.style.left=l-1+"px";var d=(e.options.width-40-20)/(e.options.width-40)*l;e.block.style.left=d+"px",e.sliderContainer.addClass("sliderContainer_active"),e.sliderMask.style.width=l+4+"px",o.push(c)},l=function(n){if(!s)return!1;if(s=!1,(n.clientX||n.changedTouches[0].clientX)===i)return!1;e.sliderContainer.removeClass("sliderContainer_active"),e.trail=o;var r=e.verify();r.spliced&&r.verified?(e.sliderContainer.addClass("sliderContainer_success"),t.isFunction(e.options.onSuccess)&&e.options.onSuccess.call(e.$element)):(e.sliderContainer.addClass("sliderContainer_fail"),t.isFunction(e.options.onFail)&&e.options.onFail.call(e.$element),setTimeout(function(){e.text.text(e.options.failedText),e.reset()},1e3))};this.slider.addEventListener("mousedown",r),this.slider.addEventListener("touchstart",r),document.addEventListener("mousemove",a),document.addEventListener("touchmove",a),document.addEventListener("mouseup",l),document.addEventListener("touchend",l),document.addEventListener("mousedown",function(){return!1}),document.addEventListener("touchstart",function(){return!1}),document.addEventListener("swipe",function(){return!1})},i.verify=function(){var t=this.trail,e=parseInt(this.block.style.left),i=!1;if(null!==this.options.remoteUrl)i=this.options.verify(t,this.options.remoteUrl);else{var n=function(t,e){return t+e},o=t.reduce(n)/t.length,s=t.map(function(t){return t-o});i=0!==Math.sqrt(s.map(function(t){return t*t}).reduce(n)/t.length)}return{spliced:Math.abs(e-this.x)<this.options.offset,verified:i}},i.reset=function(){this.sliderContainer.removeClass("sliderContainer_fail sliderContainer_success"),this.slider.style.left=0,this.block.style.left=0,this.sliderMask.style.width=0,this.clean(),this.text.attr("data-text",this.text.text()),this.text.text(this.options.loadingText),this.img.setSrc()}}(jQuery);